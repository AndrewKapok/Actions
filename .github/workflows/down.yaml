name: Daily File Processor
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download-file-1:
    name: Download Warp
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Warp with proper options
      run: |
        # 使用 -L 跟随重定向，-f 失败时退出
        curl -L -f -o warp.msi "https://1111-releases.cloudflareclient.com/win/latest"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: warp
        path: warp.msi
        retention-days: 1
        if-no-files-found: error

  download-file-2:
    name: Download Python
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Python
      run: |
        curl -L -f -o python-3.14.0-amd64.exe "https://www.python.org/ftp/python/3.14.0/python-3.14.0-amd64.exe"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: python
        path: python-3.14.0-amd64.exe
        retention-days: 1
        if-no-files-found: error

  process-and-release:
    name: Process and Create Release
    runs-on: ubuntu-latest
    needs: [download-file-1, download-file-2]
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: '*'
        merge-multiple: false
    
    - name: Prepare release files
      run: |
        mkdir -p release_files
        # 复制所有文件到 release 目录
        cp -r artifacts/*/* release_files/ || true
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: daily-$(date +%Y%m%d)
        name: Daily Build $(date +%Y-%m-%d)
        body: |
          每日自动构建的文件
          构建时间: $(date)
        draft: false
        prerelease: false
        files: |
          release_files/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
