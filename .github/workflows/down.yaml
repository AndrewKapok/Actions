name: Daily File Processor
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download-file-1:
    name: Download Warp
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Warp with proper options
      run: |
        curl -L -f -o warp.msi "https://1111-releases.cloudflareclient.com/win/latest"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: warp
        path: warp.msi
        retention-days: 1
        if-no-files-found: error

  download-file-2:
    name: Download Python
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Python
      run: |
        curl -L -f -o python-3.14.0-amd64.exe "https://www.python.org/ftp/python/3.14.0/python-3.14.0-amd64.exe"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: python
        path: python-3.14.0-amd64.exe
        retention-days: 1
        if-no-files-found: error

  process-and-release:
    name: Process and Create Release
    runs-on: ubuntu-latest
    needs: [download-file-1, download-file-2]
    
    steps:
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: '*'
        merge-multiple: false
    
    - name: Prepare release files
      run: |
        mkdir -p release_files
        cp -r artifacts/*/* release_files/ || true
        ls -la release_files/
    
    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: daily
        name: Daily Build - ${{ steps.date.outputs.date }}
        body: |
          每日自动构建的文件
          构建时间: ${{ steps.date.outputs.date }}
          
          包含文件:
          - Warp VPN 客户端 (最新版本)
          - Python 3.14.0
          
          此 Release 会每日更新，包含最新的文件版本。
        draft: false
        prerelease: false
        files: release_files/*
        overwrite: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
