name: Ollama WebUI with Cloudflare Tunnel

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      model_tag:
        description: 'æ¨¡å‹æ ‡ç­¾'
        required: true
        default: 'huihui_ai/deepseek-r1-abliterated:1.5b'
      local_port:
        description: 'æœ¬åœ°æœåŠ¡ç«¯å£'
        required: false
        default: '11434'
      timeout_minutes:
        description: 'æœåŠ¡è¿è¡Œæ—¶é•¿ (åˆ†é’Ÿ)'
        required: false
        default: '30'

jobs:
  webui:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout_minutes) || 30 }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Install Ollama
      run: |
        echo "ğŸ¤– å®‰è£… Ollama..."
        curl -fsSL https://ollama.com/install.sh | sh
        sleep 5
        
        # å¯åŠ¨ Ollama æœåŠ¡
        sudo systemctl start ollama 2>/dev/null || nohup ollama serve > ollama.log 2>&1 &
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if curl -s http://localhost:${{ github.event.inputs.local_port || '11434' }}/api/tags > /dev/null 2>&1; then
          echo "âœ… Ollama æœåŠ¡å·²å¯åŠ¨"
        else
          echo "âš ï¸ Ollama æœåŠ¡å¯èƒ½æœªå°±ç»ª"
        fi

    - name: Pull Model
      run: |
        echo "ğŸ“¦ æ‹‰å–æ¨¡å‹: ${{ github.event.inputs.model_tag }}"
        ollama pull ${{ github.event.inputs.model_tag }}
        echo "âœ… æ¨¡å‹æ‹‰å–å®Œæˆ"

    - name: Setup Cloudflare Tunnel
      id: setup_tunnel
      env:
        CF_TOKEN: ${{ secrets.CF_TOKEN }}
        LOCAL_PORT: ${{ github.event.inputs.local_port || '11434' }}
      run: |
        echo "ğŸŒ è®¾ç½® Cloudflare Tunnel..."
        
        # æ£€æŸ¥ CF_TOKEN
        if [ -n "$CF_TOKEN" ]; then
          echo "âœ… CF_TOKEN å·²è®¾ç½®"
        else
          echo "âš ï¸ CF_TOKEN æœªè®¾ç½®ï¼Œå°†ä½¿ç”¨ quick tunnel (ä¸´æ—¶éš§é“)"
        fi
        
        # å®‰è£… cloudflared
        echo "ğŸ“¦ å®‰è£… cloudflared..."
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
        sudo chmod +x /tmp/cloudflared
        sudo mv /tmp/cloudflared /usr/local/bin/cloudflared
        echo "âœ… cloudflared å®‰è£…å®Œæˆ"
        
        # éªŒè¯å®‰è£…
        cloudflared --version

    - name: Start Cloudflare Tunnel using cloudflare_tunnel.py
      id: tunnel
      env:
        CF_TOKEN: ${{ secrets.CF_TOKEN }}
        LOCAL_PORT: ${{ github.event.inputs.local_port || '11434' }}
      run: |
        echo "ğŸš€ å¯åŠ¨ Cloudflare Tunnel..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ CF_TOKENï¼Œå†³å®šä½¿ç”¨å“ªç§æ–¹å¼
        if [ -n "$CF_TOKEN" ]; then
          echo "ä½¿ç”¨ cloudflare_tunnel.py åˆ›å»ºæŒä¹…éš§é“"
          # ä½¿ç”¨ cloudflare_tunnel.py åˆ›å»ºéš§é“
          python cloudflare_tunnel.py
          
          # ç­‰å¾…éš§é“ URL æ–‡ä»¶ç”Ÿæˆ
          sleep 10
          
          if [ -f tunnel_url.txt ]; then
            TUNNEL_URL=$(cat tunnel_url.txt)
            if [ -n "$TUNNEL_URL" ]; then
              echo "âœ… Tunnel URL è·å–æˆåŠŸ: $TUNNEL_URL"
              echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ æ— æ³•ä» tunnel_url.txt è·å– URL"
            fi
          else
            echo "âš ï¸ tunnel_url.txt æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        else
          echo "ä½¿ç”¨ quick tunnel åˆ›å»ºä¸´æ—¶éš§é“"
          # ä½¿ç”¨ quick tunnel
          nohup cloudflared tunnel --url http://localhost:${LOCAL_PORT} > tunnel.log 2>&1 &
          
          # ç­‰å¾…éš§é“å¯åŠ¨
          sleep 15
          
          # æå–éš§é“ URL
          TUNNEL_URL=$(grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' tunnel.log | head -1)
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "âœ… Tunnel å¯åŠ¨æˆåŠŸ!"
            echo "ğŸŒ Tunnel URL: $TUNNEL_URL"
            echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT
            
            # ä¿å­˜ URL åˆ°æ–‡ä»¶
            echo "$TUNNEL_URL" > tunnel_url.txt
          else
            echo "âš ï¸ æ— æ³•è·å– Tunnel URLï¼ŒæŸ¥çœ‹æ—¥å¿—:"
            cat tunnel.log
          fi
        fi

    - name: Display Service Information
      run: |
        TUNNEL_URL="${{ steps.tunnel.outputs.tunnel_url }}"
        LOCAL_PORT="${{ github.event.inputs.local_port || '11434' }}"
        
        echo "========================================"
        echo "ğŸŒ Ollama WebUI æœåŠ¡çŠ¶æ€"
        echo "========================================"
        echo ""
        echo "ğŸ“ æœ¬åœ°åœ°å€: http://localhost:$LOCAL_PORT"
        
        if [ -n "$TUNNEL_URL" ]; then
          echo "ğŸ”— å…¬ç½‘åœ°å€: $TUNNEL_URL"
          echo ""
          echo "========================================"
          echo "ğŸ’¡ API ç«¯ç‚¹:"
          echo "========================================"
          echo "  - æ¨¡å‹åˆ—è¡¨: $TUNNEL_URL/api/tags"
          echo "  - ç”Ÿæˆæ–‡æœ¬: POST $TUNNEL_URL/api/generate"
          echo "  - èŠå¤©: POST $TUNNEL_URL/api/chat"
          echo ""
          echo "========================================"
          echo "ğŸ’¡ WebUI è®¿é—®:"
          echo "========================================"
          echo "  - WebUI ç•Œé¢: $TUNNEL_URL"
        fi
        
        echo ""
        echo "========================================"
        echo "âš ï¸  é‡è¦æé†’:"
        echo "========================================"
        echo "  â€¢ æœåŠ¡å°†åœ¨ ${{ github.event.inputs.timeout_minutes || '30' }} åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢"
        echo "  â€¢ è¯·å‹¿é€šè¿‡æ­¤æ–¹å¼ä¼ è¾“æ•æ„Ÿæ•°æ®"
        echo "  â€¢ ä¸´æ—¶éš§é“ URL ä»…åœ¨æœ¬æ¬¡è¿è¡ŒæœŸé—´æœ‰æ•ˆ"
        echo "========================================"

    - name: Keep Service Running
      env:
        TUNNEL_URL: ${{ steps.tunnel.outputs.tunnel_url }}
      run: |
        TIMEOUT_MINUTES=${{ github.event.inputs.timeout_minutes || '30' }}
        TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
        
        echo "ğŸ”„ ä¿æŒæœåŠ¡è¿è¡Œ ${TIMEOUT_MINUTES} åˆ†é’Ÿ..."
        echo ""
        echo "æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®æœåŠ¡:"
        echo "${{ steps.tunnel.outputs.tunnel_url }}"
        echo ""
        
        ELAPSED=0
        while [ $ELAPSED -lt $TIMEOUT_SECONDS ]; do
          sleep 30
          ELAPSED=$((ELAPSED + 30))
          REMAINING=$((TIMEOUT_SECONDS - ELAPSED))
          REMAINING_MIN=$((REMAINING / 60))
          
          # æ£€æŸ¥ Ollama æœåŠ¡çŠ¶æ€
          if curl -s http://localhost:${{ github.event.inputs.local_port || '11434' }}/api/tags > /dev/null 2>&1; then
            echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] Ollama æœåŠ¡è¿è¡Œä¸­... å‰©ä½™ ${REMAINING_MIN} åˆ†é’Ÿ"
          else
            echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] Ollama æœåŠ¡å¯èƒ½å·²åœæ­¢"
          fi
          
          # æ£€æŸ¥éš§é“çŠ¶æ€
          if [ -n "${{ steps.tunnel.outputs.tunnel_url }}" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.tunnel.outputs.tunnel_url }}" || echo "000")
            if [ "$HTTP_CODE" != "000" ]; then
              echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] Tunnel è¿æ¥æ­£å¸¸ (HTTP $HTTP_CODE)"
            else
              echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] Tunnel å¯èƒ½å·²æ–­å¼€"
            fi
          fi
        done
        
        echo "æœåŠ¡è¿è¡Œç»“æŸ"

    - name: Test Service
      continue-on-error: true
      run: |
        LOCAL_PORT="${{ github.event.inputs.local_port || '11434' }}"
        TUNNEL_URL="${{ steps.tunnel.outputs.tunnel_url }}"
        
        echo "ğŸ§ª æµ‹è¯• Ollama æœåŠ¡..."
        curl -s http://localhost:$LOCAL_PORT/api/tags | head -50 || echo "æœ¬åœ°æµ‹è¯•å¤±è´¥"
        
        if [ -n "$TUNNEL_URL" ]; then
          echo ""
          echo "ğŸ§ª æµ‹è¯• Tunnel è¿æ¥..."
          curl -s "$TUNNEL_URL/api/tags" | head -50 || echo "Tunnel æµ‹è¯•å¤±è´¥"
        fi

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: webui-logs
        path: |
          logs/
          webui.log
          ollama.log
          tunnel.log
          tunnel_url.txt
        retention-days: 1

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†èµ„æº..."
        
        # åœæ­¢ cloudflared
        pkill -f "cloudflared" 2>/dev/null || true
        
        # åœæ­¢ Ollama
        sudo systemctl stop ollama 2>/dev/null || true
        pkill -f "ollama serve" 2>/dev/null || true
        
        echo "âœ… æ¸…ç†å®Œæˆ"
