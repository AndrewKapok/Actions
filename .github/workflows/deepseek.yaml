name: Cloudflare Tunnel Test

on:
  workflow_dispatch:
    inputs:
      local_port:
        description: '本地服务端口'
        required: true
        default: '11434'
      timeout_minutes:
        description: '服务运行时长（分钟）'
        required: true
        default: '30'

jobs:
  cloudflare-tunnel-test:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(inputs.timeout_minutes) }}
    
    steps:
      # 服务准备阶段
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |    
          python -m pip install --upgrade pip
          pip install requests

      # 隧道配置阶段
      - name: Install Cloudflare Tunnel
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
          sudo chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      # 安装Ollama
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama --version

      # 下载并运行模型
      - name: Pull and Run Model
        run: |
          ollama pull huihui_ai/deepseek-r1-abliterated:8b
          ollama run huihui_ai/deepseek-r1-abliterated:8b &

      # 安装并运行WebUI
      - name: Install and Run WebUI
        run: |
          git clone https://github.com/ollama-webui/ollama-webui.git
          cd ollama-webui
          npm install
          npm run build
          npm run start > webui.log 2>&1 &
          cd ..

      # 隧道配置阶段
      - name: Start Cloudflare Tunnel
        id: start-tunnel
        run: |
          cloudflared tunnel --url http://localhost:${{ inputs.local_port }} > tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo $TUNNEL_PID > tunnel.pid
          sleep 5
          TUNNEL_URL=$(grep -o 'https\?://[^[:space:]]*trycloudflare\.com' tunnel.log | tail -1)

          if [ -z "$TUNNEL_URL" ]; then
              TUNNEL_URL=$(grep -o 'https\?://[^[:space:]]*' tunnel.log | grep trycloudflare.com | tail -1)
          fi
          echo $TUNNEL_URL > tunnel_url.txt
          echo "公网地址: $TUNNEL_URL"
          echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT

      # 保持服务运行
      - name: Keep Service Running
        run: |
          while true; do
            sleep 60
          done
