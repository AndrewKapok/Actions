name: Run Ollama with DeepSeek Model

on:
  workflow_dispatch:  # 手动触发
    inputs:
      model_tag:
        description: 'Model tag to use'
        required: true
        default: 'huihui_ai/deepseek-r1-abliterated:1.5b'
      temperature:
        description: 'Temperature for generation (0.1-2.0)'
        required: false
        default: '0.7'
  # 也可以设置定时触发
  # schedule:
  #   - cron: '0 0 * * *'

jobs:
  run-ollama:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 设置超时时间
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # 如果有requirements.txt就安装，否则只安装requests
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install requests
        fi

    - name: Install Ollama
      run: |
        curl -fsSL https://ollama.com/install.sh | sh
        echo "Ollama installed successfully"

    - name: Start Ollama service in background
      run: |
        ollama serve &
        sleep 15  # 给服务更多时间启动
        echo "Ollama service started"

    - name: Pull model
      run: |
        ollama pull ${{ github.event.inputs.model_tag || 'huihui_ai/deepseek-r1-abliterated:1.5b' }}
        echo "Model pulled successfully"

    - name: Run Python script from root
      env:
        PROMPTS_JSON: ${{ secrets.PROMPTS_JSON }}
        MODEL_TAG: ${{ github.event.inputs.model_tag || 'huihui_ai/deepseek-r1-abliterated:1.5b' }}
        TEMPERATURE: ${{ github.event.inputs.temperature || '0.7' }}
      run: |
        echo "Running Python script from root directory..."
        python run_prompts.py

    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ollama-results
        path: |
          results/
          logs/
        retention-days: 7

    - name: Clean up
      if: always()
      run: |
        echo "Cleaning up..."
        pkill ollama || true
        sleep 5