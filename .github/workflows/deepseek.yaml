name: Cloudflare Tunnel Test

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      local_port:
        description: 'æœ¬åœ°æœåŠ¡ç«¯å£'
        required: false
        default: '11434'
      timeout_minutes:
        description: 'æœåŠ¡è¿è¡Œæ—¶é•¿ (åˆ†é’Ÿ)'
        required: false
        default: '30'

jobs:
  webui:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout_minutes) || 30 }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Setup Simple HTTP Server
      run: |
        echo "ğŸš€ è®¾ç½®ç®€å•çš„ HTTP æœåŠ¡å™¨..."
        LOCAL_PORT=${{ github.event.inputs.local_port || '11434' }}
        
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•é¡µé¢
        mkdir -p test-server
        cat > test-server/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Cloudflare Tunnel æµ‹è¯•</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    text-align: center;
                    background-color: #f0f0f0;
                }
                h1 {
                    color: #333;
                }
                .success {
                    background-color: #d4edda;
                    color: #155724;
                    padding: 15px;
                    border-radius: 5px;
                    margin: 20px 0;
                }
                .info {
                    background-color: #d1ecf1;
                    color: #0c5460;
                    padding: 15px;
                    border-radius: 5px;
                    margin: 20px 0;
                }
            </style>
        </head>
        <body>
            <h1>ğŸŒ Cloudflare Tunnel æµ‹è¯•é¡µé¢</h1>
            <div class="success">
                <h2>âœ… æœåŠ¡è¿è¡Œæ­£å¸¸</h2>
                <p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•é¡µé¢ï¼Œç”¨äºéªŒè¯ Cloudflare Tunnel æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            </div>
            <div class="info">
                <h3>ğŸ“‹ æµ‹è¯•ä¿¡æ¯</h3>
                <p>æœ¬åœ°ç«¯å£: $LOCAL_PORT</p>
                <p>æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­</p>
                <p>æµ‹è¯•æ—¶é—´: $(date)</p>
            </div>
            <p>å¦‚æœæ‚¨çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯´æ˜ Cloudflare Tunnel é…ç½®æˆåŠŸï¼</p>
        </body>
        </html>
        EOF
        
        # å¯åŠ¨ HTTP æœåŠ¡å™¨
        echo "å¯åŠ¨ HTTP æœåŠ¡å™¨åœ¨ç«¯å£: $LOCAL_PORT"
        nohup python3 -m http.server $LOCAL_PORT --directory test-server > http-server.log 2>&1 &
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if curl -s http://localhost:$LOCAL_PORT > /dev/null 2>&1; then
          echo "âœ… HTTP æœåŠ¡å™¨å·²å¯åŠ¨"
          curl -s http://localhost:$LOCAL_PORT | head -30
        else
          echo "âš ï¸ HTTP æœåŠ¡å™¨å¯èƒ½æœªå°±ç»ªï¼ŒæŸ¥çœ‹æ—¥å¿—:"
          cat http-server.log
        fi

    - name: Setup Cloudflare Tunnel
      id: setup_tunnel
      env:
        LOCAL_PORT: ${{ github.event.inputs.local_port || '11434' }}
      run: |
        echo "ğŸŒ è®¾ç½® Cloudflare Tunnel..."
        
        # å®‰è£… cloudflared
        echo "ğŸ“¦ å®‰è£… cloudflared..."
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
        sudo chmod +x /tmp/cloudflared
        sudo mv /tmp/cloudflared /usr/local/bin/cloudflared
        echo "âœ… cloudflared å®‰è£…å®Œæˆ"
        
        # éªŒè¯å®‰è£…
        cloudflared --version
        
        # åˆ›å»º .cloudflared ç›®å½•å¹¶ç”Ÿæˆè¯ä¹¦ï¼ˆè§£å†³ origin certificate ç¼ºå¤±é—®é¢˜ï¼‰
        echo "ğŸ”‘ å‡†å¤‡ Cloudflare è¯ä¹¦..."
        mkdir -p ~/.cloudflared
        # ç”Ÿæˆè¯ä¹¦ï¼ˆç”¨äºæŒä¹…åŒ–éš§é“ï¼ŒQuick Tunnel ä¹Ÿä¼šä½¿ç”¨ï¼‰
        cloudflared tunnel login 2>/dev/null || true
        # å³ä½¿ç™»å½•å¤±è´¥ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªç©ºçš„è¯ä¹¦æ–‡ä»¶ä½œä¸ºå ä½ç¬¦
        touch ~/.cloudflared/cert.pem
        echo "âœ… è¯ä¹¦å‡†å¤‡å®Œæˆ"

    - name: Start Cloudflare Tunnel
      id: tunnel
      env:
        LOCAL_PORT: ${{ github.event.inputs.local_port || '11434' }}
        CF_TOKEN: ${{ secrets.CF_TOKEN }}
      run: |
        echo "ğŸš€ å¯åŠ¨ Cloudflare Tunnel..."
        
        LOCAL_PORT=${{ github.event.inputs.local_port || '11434' }}
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ CF_TOKEN
        if [ -n "$CF_TOKEN" ]; then
          echo "ğŸ”‘ æ£€æµ‹åˆ° CF_TOKENï¼Œä½¿ç”¨æŒä¹…åŒ–éš§é“æ¨¡å¼..."
          
          # åˆ›å»ºéš§é“åç§°
          TUNNEL_NAME="github-actions-tunnel-$(date +%s)"
          
          # ç™»å½• Cloudflare
          echo "ğŸ” ç™»å½• Cloudflare..."
          cloudflared tunnel login --api-token $CF_TOKEN 2>/dev/null || true
          
          # åˆ›å»ºéš§é“
          echo "ğŸŒ åˆ›å»ºæŒä¹…åŒ–éš§é“: $TUNNEL_NAME"
          cloudflared tunnel create $TUNNEL_NAME --api-token $CF_TOKEN 2>&1 || true
          
          # è·å–éš§é“ ID
          TUNNEL_ID=$(grep -o 'Created tunnel \([a-f0-9-]*\)' tunnel.log 2>/dev/null | head -1 | awk '{print $3}' || echo "")
          
          if [ -n "$TUNNEL_ID" ]; then
            # é…ç½®éš§é“
            echo "ğŸ“ é…ç½®éš§é“..."
            mkdir -p ~/.cloudflared
            cat > ~/.cloudflared/config.yml << EOF
tunnel: $TUNNEL_ID
credentials-file: ~/.cloudflared/$TUNNEL_ID.json
ingress:
  - hostname: "*"
    service: http://localhost:$LOCAL_PORT
  - service: http_status:404
EOF

            # å¯åŠ¨éš§é“
            echo "ğŸš€ å¯åŠ¨æŒä¹…åŒ–éš§é“..."
            nohup cloudflared tunnel run $TUNNEL_NAME --api-token $CF_TOKEN > tunnel.log 2>&1 &
          else
            echo "âš ï¸ æ— æ³•åˆ›å»ºæŒä¹…åŒ–éš§é“ï¼Œå›é€€åˆ° Quick Tunnel..."
            # å›é€€åˆ° Quick Tunnel
            nohup cloudflared tunnel --url http://localhost:$LOCAL_PORT > tunnel.log 2>&1 &
          fi
        else
          echo "ğŸŒ æœªæ£€æµ‹åˆ° CF_TOKENï¼Œä½¿ç”¨ Quick Tunnel æ¨¡å¼..."
          # ä½¿ç”¨ quick tunnel åˆ›å»ºä¸´æ—¶éš§é“
          echo "åˆ›å»º Quick Tunnel æŒ‡å‘: http://localhost:$LOCAL_PORT"
          nohup cloudflared tunnel --url http://localhost:$LOCAL_PORT > tunnel.log 2>&1 &
        fi
        
        # ç­‰å¾…éš§é“å¯åŠ¨
        sleep 20
        
        # æå–éš§é“ URL
        TUNNEL_URL=$(grep -o 'https://[a-z0-9-]*\.trycloudflare\.com' tunnel.log | head -1)
        
        if [ -n "$TUNNEL_URL" ]; then
          echo "âœ… Tunnel å¯åŠ¨æˆåŠŸ!"
          echo "ğŸŒ Tunnel URL: $TUNNEL_URL"
          echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT
          
          # ä¿å­˜ URL åˆ°æ–‡ä»¶
          echo "$TUNNEL_URL" > tunnel_url.txt
        else
          echo "âš ï¸ æ— æ³•è·å– Tunnel URLï¼ŒæŸ¥çœ‹æ—¥å¿—:"
          cat tunnel.log
          
          # å°è¯•ä½¿ç”¨å¦ä¸€ç§æ–¹å¼è·å– URL
          TUNNEL_URL=$(tail -20 tunnel.log | grep -o 'https://[a-z0-9-]*\.trycloudflare\.com')
          if [ -n "$TUNNEL_URL" ]; then
            echo "âœ… ä»æ—¥å¿—å°¾éƒ¨è·å– Tunnel URL: $TUNNEL_URL"
            echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT
            echo "$TUNNEL_URL" > tunnel_url.txt
          else
            echo "âš ï¸ æ— æ³•è·å– Tunnel URLï¼ŒæœåŠ¡å¯èƒ½æ— æ³•ä»å¤–ç½‘è®¿é—®"
          fi
        fi

    - name: Display Service Information
      run: |
        TUNNEL_URL="${{ steps.tunnel.outputs.tunnel_url }}"
        LOCAL_PORT="${{ github.event.inputs.local_port || '11434' }}"
        
        echo "========================================"
        echo "ğŸŒ Cloudflare Tunnel æµ‹è¯•æœåŠ¡çŠ¶æ€"
        echo "========================================"
        echo ""
        echo "ğŸ“ æœ¬åœ°åœ°å€: http://localhost:$LOCAL_PORT"
        
        if [ -n "$TUNNEL_URL" ]; then
          echo "ğŸ”— å…¬ç½‘åœ°å€: $TUNNEL_URL"
          echo ""
          echo "========================================"
          echo "ğŸ’¡ è®¿é—®ä¿¡æ¯:"
          echo "========================================"
          echo "  - æµ‹è¯•é¡µé¢: $TUNNEL_URL"
          echo "  - æœ¬åœ°æµ‹è¯•: http://localhost:$LOCAL_PORT"
        fi
        
        echo ""
        echo "========================================"
        echo "âš ï¸  é‡è¦æé†’:"
        echo "========================================"
        echo "  â€¢ æœåŠ¡å°†åœ¨ ${{ github.event.inputs.timeout_minutes || '30' }} åˆ†é’Ÿåè‡ªåŠ¨åœæ­¢"
        echo "  â€¢ è¯·å‹¿é€šè¿‡æ­¤æ–¹å¼ä¼ è¾“æ•æ„Ÿæ•°æ®"
        echo "  â€¢ ä¸´æ—¶éš§é“ URL ä»…åœ¨æœ¬æ¬¡è¿è¡ŒæœŸé—´æœ‰æ•ˆ"
        echo "========================================"

    - name: Keep Service Running
      env:
        TUNNEL_URL: ${{ steps.tunnel.outputs.tunnel_url }}
      run: |
        TIMEOUT_MINUTES=${{ github.event.inputs.timeout_minutes || '30' }}
        TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
        
        echo "ğŸ”„ ä¿æŒæœåŠ¡è¿è¡Œ ${TIMEOUT_MINUTES} åˆ†é’Ÿ..."
        echo ""
        echo "æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®æœåŠ¡:"
        echo "${{ steps.tunnel.outputs.tunnel_url }}"
        echo ""
        
        ELAPSED=0
        while [ $ELAPSED -lt $TIMEOUT_SECONDS ]; do
          sleep 30
          ELAPSED=$((ELAPSED + 30))
          REMAINING=$((TIMEOUT_SECONDS - ELAPSED))
          REMAINING_MIN=$((REMAINING / 60))
          
          # æ£€æŸ¥ HTTP æœåŠ¡å™¨çŠ¶æ€
          if curl -s http://localhost:${{ github.event.inputs.local_port || '11434' }} > /dev/null 2>&1; then
            echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] HTTP æœåŠ¡å™¨è¿è¡Œä¸­... å‰©ä½™ ${REMAINING_MIN} åˆ†é’Ÿ"
          else
            echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] HTTP æœåŠ¡å™¨å¯èƒ½å·²åœæ­¢"
          fi
          
          # æ£€æŸ¥éš§é“çŠ¶æ€
          if [ -n "${{ steps.tunnel.outputs.tunnel_url }}" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.tunnel.outputs.tunnel_url }}" || echo "000")
            if [ "$HTTP_CODE" != "000" ]; then
              echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] Tunnel è¿æ¥æ­£å¸¸ (HTTP $HTTP_CODE)"
            else
              echo "[$ELAPSED/$TIMEOUT_SECONDS ç§’] Tunnel å¯èƒ½å·²æ–­å¼€"
            fi
          fi
        done
        
        echo "æœåŠ¡è¿è¡Œç»“æŸ"

    - name: Test Service
      continue-on-error: true
      run: |
        LOCAL_PORT="${{ github.event.inputs.local_port || '11434' }}"
        TUNNEL_URL="${{ steps.tunnel.outputs.tunnel_url }}"
        
        echo "ğŸ§ª æµ‹è¯• HTTP æœåŠ¡å™¨..."
        curl -s http://localhost:$LOCAL_PORT | head -30 || echo "æœ¬åœ°æµ‹è¯•å¤±è´¥"
        
        if [ -n "$TUNNEL_URL" ]; then
          echo ""
          echo "ğŸ§ª æµ‹è¯• Tunnel è¿æ¥..."
          curl -s "$TUNNEL_URL" | head -30 || echo "Tunnel æµ‹è¯•å¤±è´¥"
        fi

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: tunnel-test-logs
        path: |
          http-server.log
          tunnel.log
          tunnel_url.txt
        retention-days: 1
        if-no-files-found: warn

    - name: Cleanup
      if: always()
      env:
        CF_TOKEN: ${{ secrets.CF_TOKEN }}
      run: |
        echo "ğŸ§¹ æ¸…ç†èµ„æº..."
        
        # åœæ­¢ cloudflared
        pkill -f "cloudflared" 2>/dev/null || true
        
        # å¦‚æœæœ‰ CF_TOKENï¼Œæ¸…ç†æŒä¹…åŒ–éš§é“
        if [ -n "$CF_TOKEN" ]; then
          echo "ğŸ”„ æ¸…ç†æŒä¹…åŒ–éš§é“..."
          # è·å–éš§é“ ID å¹¶åˆ é™¤
          TUNNEL_ID=$(grep -o 'Created tunnel \([a-f0-9-]*\)' tunnel.log 2>/dev/null | head -1 | awk '{print $3}' || echo "")
          if [ -n "$TUNNEL_ID" ]; then
            cloudflared tunnel delete -f $TUNNEL_ID --api-token $CF_TOKEN 2>/dev/null || true
            echo "âœ… æŒä¹…åŒ–éš§é“å·²æ¸…ç†"
          fi
        fi
        
        # åœæ­¢ HTTP æœåŠ¡å™¨
        pkill -f "python3 -m http.server" 2>/dev/null || true
        
        echo "âœ… æ¸…ç†å®Œæˆ"
